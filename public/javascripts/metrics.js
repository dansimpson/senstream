/* ts.js - version 0.9.0 - Copyright 2012 Dan Simpson, Mike Countis - MIT License */
!function(){var t,e,i,s,n,o,r,a={}.hasOwnProperty,h=function(t,e){function i(){this.constructor=t}for(var s in e)a.call(e,s)&&(t[s]=e[s]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};n=function(){function n(){}return n.prototype.validate=function(t){if(0===t.length)throw"Timeseries expects an array of data.";if(2!==t[0].length)throw"Timeseries expects input like [[timestamp, value]...]";if("number"!=typeof t[0][0])throw"Timeseries expects timestamps; eg: [[timestamp, value]...]"},n.prototype.timestamp=function(t,e,i){var s,n,o,r,a;for(null==e&&(e=(new Date).getTime()),null==i&&(i=6e4),s=0,n=[],r=0,a=t.length;a>r;r++)o=t[r],n.push([e+s++*i,o]);return n},n.prototype.wrap=function(t){return this.validate(t),new s(t)},n.prototype.numeric=function(t){if(this.validate(t),"number"!=typeof t[0][1])throw"NumericTimeseries expects timestamps and numbers; eg: [[timestamp, number]...]";return new i(t)},n.prototype.multi=function(t){return this.validate(t),new e(t)},n.prototype.build=function(t){return this.validate(t),"number"==typeof t[0][1]?this.numeric(t):"string"==typeof t[0][1]?this.wrap(t):this.multi(t)},n.prototype.buffer=function(e){return null==e&&(e=[]),new t(e)},n}(),o=new n,t=function(){function t(t){this.data=null!=t?t:[]}return t.prototype.append=function(t){if(!(t instanceof Array))throw"Buffer.append expects array: [t,v] or [[t,v],[t,v]]";return t[0]instanceof Array?this.data=this.data.concat(t):this.data.push(t)},t.prototype.shift=function(t){var e;return e=this.data.slice(0,t),this.data=this.data.slice(t,this.size()),e},t.prototype.size=function(){return this.data.length},t}(),s=function(){function t(t){this.data=t,this.squelched=!1,this.listeners=[]}return t.prototype.size=function(){return this.data.length},t.prototype.length=function(){return this.data.length},t.prototype.count=function(){return this.data.length},t.prototype.first=function(){return this.data[0]},t.prototype.last=function(){return this.data[this.size()-1]},t.prototype.sample=function(t){return this.data[t]},t.prototype.time=function(t){return this.data[t][0]},t.prototype.value=function(t){return this.data[t][1]},t.prototype.domain=function(){return[this.first()[0],this.last()[0]]},t.prototype.shift=function(){var t;return t=this.data.shift(),this.notify(),t},t.prototype.pop=function(){return this.shift()},t.prototype.append=function(t,e){if(t<this.end())throw"Can't append sample with past timestamp";return this.data.push([t,e]),this.notify()},t.prototype.push=function(t,e){return this.append(t,e)},t.prototype.add=function(t,e){return this.append(t,e)},t.prototype.pushpop=function(t,e,i){if(null==i&&(i=0),this.squelched=!0,this.append(t,e),i>0)for(;this.size()>i;)this.shift();return this.squelched=!1,this.notify},t.prototype.streambuf=function(t,e){var i=this;return null==t&&(t=60),null==e&&(e=0),this.buffer=$ts.buffer(),this.interval=setInterval(function(){var s,n,o,r,a,h,u,l,c;if(0!==i.buffer.size()){for(i.squelched=!0,u=i.buffer.shift(Math.ceil(i.buffer.size()/t)),r=0,h=u.length;h>r;r++)l=u[r],s=l[0],n=l[1],i.append(s,n);if(i.size()>e)for(o=a=0,c=i.size()-e;c>=0?c>=a:a>=c;o=c>=0?++a:--a)i.shift();return i.squelched=!1,i.notify()}},1e3/t),this.buffer},t.prototype.notify=function(){var t,e,i,s,n;if(!this.squelched){for(s=this.listeners,n=[],e=0,i=s.length;i>e;e++)t=s[e],n.push(t());return n}},t.prototype.listen=function(t){return this.listeners.push(t)},t.prototype.values=function(){var t,e,i,s,n,o,r;for(t=[],o=this.data,s=0,n=o.length;n>s;s++)r=o[s],e=r[0],i=r[1],t.push(i);return t},t.prototype.duration=function(){return this.end()-this.start()},t.prototype.start=function(){return this.first()[0]},t.prototype.end=function(){return this.last()[0]},t.prototype.scan=function(t,e){var i,s;return i=this.nearest(t),s=this.nearest(e),this.time(i)<t&&++i,this.time(s)<e&&++s,new this.constructor(this.data.slice(i,s))},t.prototype.filter=function(t){var e,i,s,n,o;for(e=[],o=this.data,s=0,n=o.length;n>s;s++)i=o[s],t(i[0],i[1])&&e.push(i);return new this.constructor(e)},t.prototype.split=function(t){var e,i,s,n,o,r;for(e=[],i=[],r=this.data,n=0,o=r.length;o>n;n++)s=r[n],s[0]<=t?e.push(s):i.push(s);return[new this.constructor(e),new this.constructor(i)]},t.prototype.map=function(t){var e,i,s,n,o;for(e=[],o=this.data,s=0,n=o.length;n>s;s++)i=o[s],e.push(t(i[0],i[1]));return new this.constructor(e)},t.prototype.timestamps=function(){var t,e,i,s,n,o,r;for(t=[],o=this.data,s=0,n=o.length;n>s;s++)r=o[s],e=r[0],i=r[1],t.push(e);return t},t.prototype.nearest=function(t){return this.bsearch(t,0,this.size()-1)},t.prototype.bsearch=function(t,e,i){var s,n,o;return o=Math.floor((i-e)/2)+e,e===o?(s=Math.abs(this.time(e)-t),n=Math.abs(this.time(i)-t),n>s?e:i):t<this.time(o)?this.bsearch(t,e,o):t>this.time(o)?this.bsearch(t,o,i):o},t.prototype.toString=function(){return"Timeseries\nitems   : "+this.size()+"\ndomain  : "+this.domain()},t}(),i=function(t){function e(t){this.data=t,e.__super__.constructor.call(this,this.data)}return h(e,t),e.prototype.statistics=function(){var t,e,i,s,n,o,r,a,h,u;if(this._stats)return this._stats;for(i=0,s=0,e=1/0,t=-1/0,h=this.data,r=0,a=h.length;a>r;r++)u=h[r],n=u[0],o=u[1],i+=o,s+=o*o,o>t&&(t=o),e>o&&(e=o);return this._stats={sum:i,min:e,max:t,sum2:s}},e.prototype.shift=function(){var t,e,i,s,n,o,r,a,h,u,l,c,p;if(t=this.data.shift(),n=t[1],this._stats){if(this._stats.sum-=n,this._stats.sum2-=n*n,n===this._stats.min){for(i=1/0,u=this.data,o=0,a=u.length;a>o;o++)l=u[o],s=l[0],n=l[1],i=Math.min(n,i);this._stats.min=i}if(n===this._stats.max){for(e=-1/0,c=this.data,r=0,h=c.length;h>r;r++)p=c[r],s=p[0],n=p[1],e=Math.max(n,e);this._stats.max=e}}return this.notify(),t},e.prototype.append=function(t,i){if(t<this.end())throw"Can't append sample with past timestamp";return this._stats&&(this._stats.sum+=i,this._stats.sum2+=i*i,this._stats.min=Math.min(this._stats.min,i),this._stats.max=Math.max(this._stats.max,i)),e.__super__.append.call(this,t,i)},e.prototype.sum=function(){return this.statistics().sum},e.prototype.sumsq=function(){return this.statistics().sum2},e.prototype.variance=function(){var t,e,i,s,n,o,r,a;for(e=0,r=this.data,n=0,o=r.length;o>n;n++)a=r[n],i=a[0],s=a[1],t=s-this.mean(),e+=t*t;return e/(this.size()-1)},e.prototype.stddev=function(){return Math.sqrt(this.sumsq()/this.size()/(this.mean()*this.mean()))},e.prototype.mean=function(){return this.sum()/this.size()},e.prototype.range=function(){return[this.min(),this.max()]},e.prototype.span=function(){return this.max()-this.min()},e.prototype.min=function(){return this.statistics().min},e.prototype.max=function(){return this.statistics().max},e.prototype.values=function(){var t,e,i,s,n,o,r;for(t=[],o=this.data,s=0,n=o.length;n>s;s++)r=o[s],e=r[0],i=r[1],t.push(i);return t},e.prototype.valuesSorted=function(){return this._valuesSorted?this._valuesSorted:this._valuesSorted=this.values().sort(function(t,e){return t-e})},e.prototype.median=function(){var t;return t=Math.floor(this.size()/2),this.size()%2?this.valuesSorted()[t]:(this.valuesSorted()[t-1]+this.valuesSorted()[t])/2},e.prototype.rollup=function(t,e){var i,s,n,o,r,a,h,u,l,c;for(s=t/2,n=[],r=this.start(),i=[],l=this.data,h=0,u=l.length;u>h;h++)c=l[h],o=c[0],a=c[1],o-r>=t&&(n.push([r+s,e(r,i)]),i=[],r=o),i.push(a);return i.length>0&&n.push([r+s,e(r,i)]),new this.constructor(n)},e.prototype.norms=function(){var t,e,i,s,n,o,r;for(t=[],o=this.data,s=0,n=o.length;n>s;s++)r=o[s],e=r[0],i=r[1],t.push((i-this.mean())/this.stddev());return t},e.prototype.simplify=function(t){var e,i,n,o,r,a,h;for(null==t&&(t=.1),e=this.first(),n=this.max()-this.min(),i=[e],h=this.data,r=0,a=h.length;a>r;r++)o=h[r],Math.abs(o[1]-e[1])/n>t&&(e[0]!==i[i.length-1][0]&&i.push(e),i.push(o)),e=o;return e[0]!==i[i.length-1][0]&&i.push(e),new s(i)},e.prototype.match=function(t){var e,i,n,o,r,a,h,u;if(!(t instanceof s))throw"Must match against a Timeseries object";if(e=999999999,o=-1,r=t.norms(),a=this.norms(),!(r.length<=a.length))throw"Query length exceeds source length";for(n=h=0,u=a.length-r.length-1;u>=0?u>=h:h>=u;n=u>=0?++h:--h)i=this._distance(r,a.slice(n,+(n+r.length)+1||9e9)),e>i&&(e=i,o=n);return o},e.prototype._distance=function(t,e){var i,s,n,o,r;if(t.length!==e.length)throw"Array lengths must match for distance";for(n=0,s=o=0,r=t.length-1;r>=0?r>=o:o>=r;s=r>=0?++o:--o)i=e[s]-t[s],n+=i*i;return Math.sqrt(n)},e.prototype.toString=function(){return"Timeseries\nitems   : "+this.size()+"\nmean    : "+this.mean()+"\nstddev  : "+this.stddev()+"\ndomain  : "+this.domain()+"\nrange   : "+this.range()+"\nvariance: "+this.variance()},e}(s),e=function(t){function e(t){var i,s,n,r,a,h,u,l;this.data=t,e.__super__.constructor.call(this,this.data),this.lookup={},this.attrs=[],h=t[0][1];for(i in h)n=h[i],this.attrs.push(i),this.lookup[i]=[];for(r=0,a=t.length;a>r;r++){s=t[r],u=s[1];for(i in u)n=u[i],this.lookup[i].push([s[0],n])}l=this.lookup;for(i in l)n=l[i],this.lookup[i]="number"==typeof this.lookup[i][0][1]?o.numeric(this.lookup[i]):o.multi(this.lookup[i])}return h(e,t),e.prototype.series=function(t){var e,i;if("/"===t[0])return this.series(t.substr(1));if(t.indexOf("/")>0){if(i=t.split("/"),e=i.shift(),!this.lookup[e])throw"Can't get attribute "+e+" of multi time series";return this.lookup[e].series(i.join("/"))}if(!this.lookup[t])throw"Can't get attribute "+t+" of multi time series";return this.lookup[t]},e.prototype.append=function(t,i){var s,n;for(s in i)n=i[s],this.lookup[s].append(t,n);return e.__super__.append.call(this,t,i)},e.prototype.shift=function(){var t,i,s,n;for(n=this.attrs,i=0,s=n.length;s>i;i++)t=n[i],this.lookup[t].shift();return e.__super__.shift.call(this)},e.prototype.attr=function(t){return this.series(t)},e}(s),r="undefined"!=typeof module&&module.exports?module.exports:window,r.$ts=o}.call(this),/* metrics.js copyright 2013 Dan Simpson - MIT License */
function(t){function e(t,e,i){this.options=i,this.update(t),this.updateEl(e)}function i(t,e){var i=document.createElement("canvas");return $(i).css({position:"absolute"}),i.setAttribute("height",e),i.setAttribute("width",t),i}function s(t){var e=t.el,i=t.bus,s=-1;e.mousemove(function(n){var o=n.pageX-e.offset().left;s>-1?i.publish("highlight",[t.scale.time(s),t.scale.time(o)]):i.publish("hover",t.scale.time(o))}),t.options.zoomable&&(e.mousedown(function(t){s=t.pageX-e.offset().left}),e.mouseup(function(n){var o=n.pageX-e.offset().left;if(Math.abs(s-o)>5){var r=t.scale.time(s),a=t.scale.time(o);i.publish("zoom",[Math.min(r,a),Math.max(r,a)])}s=-1}))}function n(){}function o(){this.topics={}}var r=requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(t){window.setTimeout(t,20)};e.prototype={x:function(t){return(t-this.t1)/(this.t2-this.t1)*this.width},y:function(t){return this.height-(t-this.min)/(this.max-this.min)*this.height},time:function(t){return t/this.width*(this.t2-this.t1)+this.t1},value:function(t){return this.max-t/this.height*(this.max-this.min)},update:function(t){this.t1=t.start(),this.t2=t.end(),this.min=t.min(),this.max=t.max(),this.options.hasOwnProperty("range")&&(this.min=Math.min(this.range[0],this.min),this.max=Math.max(this.range[1],this.min))},updateEl:function(t){this.width=t.width(),this.height=t.height()}},o.prototype={subscribe:function(t,e){this.subscribers(t).push(e)},on:function(t,e){this.subscribers(t).push(e)},subscribers:function(t){return this.topics.hasOwnProperty(t)||(this.topics[t]=[]),this.topics[t]},publish:function(t,e){for(var i=this.subscribers(t),s=0;s<i.length;s++)try{i[s](e)}catch(n){console.error("Callback invokation failure",n)}}};var a={"default":new o},h={group:"default",height:50,interactive:!0,zoomable:!0},u={};t.$metrics={register:function(t,e){u[t]=e},defaults:function(t){h=$.extend(!0,h,t)},render:function(t,l){function c(t,e){x[t]=e}if(!t||!l)throw"ts and settings parameters required for render";if(!l.hasOwnProperty("container"))throw"render settings require el option";var p=$.extend({},h,l.options),f=l.container,m=a[p.group],d=new o,v=[],g=$("<div>").addClass("metric").css($.extend({height:50,position:"relative","user-select":"none"},p.css||{}));f.append(g);var y=new e(t,g,p),b={el:g,ts:t,bus:m,options:p,scale:y},w=$.map(l.layers,function(e){var s,n,o;if("string"==typeof e?(s=e,o=$.extend(o,p[s]),n=u[s]):"object"==typeof e?(s=e.name,o=$.extend(o,p[s],e.options),n=u[s]):"function"==typeof e&&(n=e,o={}),null===n)throw"Unknown plugin: "+s;var r={bus:d,el:g,ts:t,scale:y,options:o};if(o.canvas!==!1){var a=i(y.width,y.height);r.canvas=a,r.context=a.getContext("2d"),g.append(a)}return{instance:n(r),context:r}}),x={};return function _(){d.publish("enter");for(var t in x)d.publish(t,x[t]);d.publish("exit"),x={},r(_)}(),t.listen(function(){v.length>0||(y.update(t),c("scale"))}),$(window).resize(function(){y.updateEl(g),$.each(w,function(t,e){e.context.hasOwnProperty("canvas")&&e.context.canvas.setAttribute("width",g.width())}),c("scale")}),p.interactive&&(document.documentElement.hasOwnProperty("ontouchstart")?n(b):s(b)),m.subscribe("hover",function(t){c("hover",t)}),m.subscribe("highlight",function(t){c("highlight",t)}),m.subscribe("zoom",function(e){v.push(t),t=t.scan(e[0],e[1]),y.update(t);for(var i=0;i<w.length;i++)w[i].context.ts=t;c("zoom",e),c("scale")}),m.subscribe("unzoom",function(){if(0!=v.length){t=v.pop(),y.update(t);for(var e=0;e<w.length;e++)w[e].context.ts=t;c("unzoom"),c("scale")}}),g},publish:function(t,e,i){a.hasOwnProperty(t)&&a[t].publish(e,i)},formatDate:function(t,e){var i={"M+":t.getMonth()+1,"d+":t.getDate(),"h+":t.getHours(),"m+":t.getMinutes(),"s+":t.getSeconds(),"q+":Math.floor((t.getMonth()+3)/3),S:t.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(t.getFullYear()+"").substr(4-RegExp.$1.length)));for(var s in i)if(new RegExp("("+s+")").test(e)){var n=1==RegExp.$1.length?i[s]:("00"+i[s]).substr((""+i[s]).length);e=e.replace(RegExp.$1,n)}return e}}}(window),$metrics.defaults({datebar:{css:{height:"32px","line-height":"32px",position:"relative"},canvas:!1,format:"yyyy-MM-dd hh:mm:ss"}}),$metrics.register("datebar",function(t){var e=t.options,i=t.bus,s=t.scale,n=function(t){return $metrics.formatDate(new Date(t),e.format)},o=$("<div>").addClass("datebar").css(e.css),r=$("<div>").addClass("date").css({position:"absolute",left:0}).html(n(t.ts.start())),a=$("<div>").addClass("date").css({position:"absolute",right:0}).html(n(t.ts.end())),h=$("<div>").addClass("date").css({position:"absolute"});t.el.append(o),o.append(r),o.append(a),o.append(h);var u,l=r.outerWidth(!0),c=a.outerWidth(!0);i.on("hover",function(e){h.html(n(e)),u=t.scale.x(e);var i=h.outerWidth(!0),o=u-i/2;0>o?o=0:o+i>s.width&&(o=s.width-i),l>o?r.hide():r.show(),o+i>s.width-c?a.hide():a.show(),h.css({left:o})}),i.on("scale",function(){u&&h.html(n(t.scale.time(u))),r.html(n(t.ts.start())),a.html(n(t.ts.end()))})}),$metrics.register("histogram",function(t){function e(e){for(var i=t.ts.min(),s=t.ts.max(),n=t.ts.values(),o=Array(e),r=0;e>r;r++)o[r]=0;for(var r=0;r<n.length;r++){var a=(n[r]-i)/(s-i);o[Math.min(Math.floor(a*e),e-1)]+=1}return o}function i(){var t=s.bins,i=e(t),r=Math.min.apply(Math,i),a=Math.max.apply(Math,i),h=(n.width-t-1)/t,u=a-r;if(o.clearRect(0,0,n.width,n.height),o.fillStyle=s.fill,!(0>=u))for(var l=0;l<i.length;l++)v=(i[l]-r)/u*n.height,o.fillRect(l+h*l,n.height-v,h,v)}var s=t.options,n=t.scale,o=t.context,r=t.bus;i(),r.on("scale",i)}),$metrics.defaults({histogram:{bins:5,fill:"rgba(50,220,200,0.80)"}}),$metrics.defaults({labels:{canvas:!1,format:function(t){return t.toFixed(2)}}}),$metrics.register("labels",function(t){function e(){o.html(s(t.ts.min())),n.html(s(t.ts.max()))}var i=t.bus,s=t.options.format,n=$("<div>").addClass("label max").css({position:"absolute",left:0,top:0}),o=$("<div>").addClass("label min").css({position:"absolute",left:0,bottom:0});t.el.append(o),t.el.append(n),e(),i.on("scale",e)}),$metrics.register("line",function(t){function e(e){return s.rollup===!1?e:t.ts.rollup(s.rollup.duration,s.rollup.fn)}function i(){var i=e(t.ts).data,n=t.context,o=t.scale;n.clearRect(0,0,o.width,o.height),n.strokeStyle=s.stroke,n.fillStyle=s.fill,n.beginPath(),n.moveTo(o.x(i[0][0]),o.y(0));for(var r=0;r<i.length;r++){var a=o.x(i[r][0]),h=o.y(i[r][1]);n.lineTo(a,h)}n.stroke(),n.lineTo(o.x(i[i.length-1][0]),o.y(0)),s.fill!==!1&&n.fill(),n.closePath()}var s=t.options,n=t.bus;i(),n.on("scale",i),n.on("overlay:hover",function(e){var i=t.scale,s=e.x,n=e.ctx,o=i.x(e.time),r=i.y(e.value);Math.abs(o-s)>2&&(n.moveTo(s,i.height/2),n.lineTo(o,r)),n.arc(o,r,2,0,2*Math.PI,!1),n.fill()})}),$metrics.defaults({line:{stroke:"rgb(50,220,200)",fill:!1,rollup:!1}}),$metrics.register("logger",function(t){var e=t.bus;console.log("layer intialized"),console.log(t),e.on("hover",function(e){console.log("hover called",e,t)}),e.on("scale",function(){console.log("scaled called",t)}),e.on("highlight",function(e){console.log("highlight called",e,t)})}),$metrics.defaults({overlay:{stroke:"rgba(100,100,100,0.50)",fill:"rgba(255,255,255,0.25)",css:{position:"absolute",left:0},format:function(t,e){return e.toPrecision(2)}}}),$metrics.register("overlay",function(t){function e(){var e=t.scale,i=t.context,a=t.ts,l=e.x(o),c=a.nearest(o),p=a.time(c),f=a.value(c);if(r=l,i.clearRect(0,0,e.width,e.height),null==s)i.strokeStyle=h.stroke,i.fillStyle=h.stroke,i.beginPath(),i.moveTo(l,0),i.lineTo(l,e.height),i.stroke(),i.closePath(),t.bus.publish("overlay:hover",{x:l,ctx:i,idx:c,time:p,value:f}),u.css({left:l+5}).html(h.format(p,f));else{i.fillStyle=h.fill,n=[e.x(s[0]),e.x(s[1])];var l=n[0];i.fillRect(l,0,n[1]-l,e.height)}}var i=!1,s=null,n=null,o=null,r=null,a=t.bus,h=t.options,u=$("<div>").addClass("overlay").css(h.css).html(h.format(0,0));t.el.append(u),u.css({top:t.scale.height/2-u.outerHeight()/2});var l=t.context;l.strokeStyle=h.color,l.fillStyle=h.color,a.on("enter",function(){i=!1}),a.on("exit",function(){i&&e()}),a.on("hover",function(t){o=t,i=!0}),a.on("scale",function(){var e=t.scale;null!=n?s=[e.time(n[0]),e.time(n[1])]:null!=r&&(o=e.time(r)),i=!0}),a.on("zoom",function(){s=n=null,i=!0}),a.on("highlight",function(t){s=t,i=!0})}),$metrics.register("scatter",function(t){function e(){var e=t.context,i=t.ts.data,r=t.scale;e.clearRect(0,0,r.width,r.height),e.fillStyle=s.fill,e.beginPath();for(var a=0;a<i.length;a++)e.fillRect(r.x(i[a][0])-n,r.y(i[a][1])-n,o,o);e.closePath(),e.fill()}var i=t.bus;2*Math.PI;var s=t.options,n=s.radius,o=2*n;e(),i.on("scale",e),i.on("overlay:hover",function(e){var i=t.scale,r=e.ctx;r.fillStyle=s.hover,r.fillRect(i.x(e.time)-n,i.y(e.value)-n,o,o)})}),$metrics.defaults({scatter:{fill:"rgb(200,200,200)",hover:"rgb(230,230,230)",radius:2}});